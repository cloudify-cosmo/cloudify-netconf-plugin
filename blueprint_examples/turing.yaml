tosca_definitions_version: cloudify_dsl_1_2

imports:
  - turing-yttc-generated.yaml

inputs:

  netconf_ip:
    type: string
    description: >
       netconf server ip
    default: 127.0.0.1

  netconf_user:
    type: string
    description: >
       netconf server user
    default: netconf
  netconf_password:
    type: string
    description: >
       netconf server user password
    default: netconf

  netconf_key_content:
    type: string
    description: >
       netconf server user rsa key content, can be used instead password
    default: ""

node_templates:


  turing-machine-update-config-impl:
    type: turing-machine
    properties:
      netconf_auth:
        user: { get_input: netconf_user }
        password: { get_input: netconf_user }
        ip: { get_input: netconf_ip }
        key_content: { get_input: netconf_key_content }
      turing@initialize:
        turing@tape-content: 101010101
      edit-config:
        error-option: rollback-on-error
        target:
          running: {}
        config:
          turing@turing-machine:
            turing@transition-function:
              turing@delta:
                - turing@label: 1
                  turing@input:
                    turing@symbol: 0
                    turing@state: 0
                  turing@output:
                    turing@symbol: {}
                    turing@state: 1
                    turing@head-move: right
                - turing@label: 2
                  turing@input:
                    turing@symbol: 0
                    turing@state: 1
                  turing@output:
                    turing@symbol: 0
                    turing@state: 1
                    turing@head-move: right

    interfaces:
      cloudify.interfaces.lifecycle:
        create:
          inputs:
            calls:
              - action: get-config
                payload: { get_property: [ turing-machine-update-config-impl, get-config ] }
                # save all results to saved-config
                save_to: saved-config
        configure:
          inputs:
            calls:
              - action: lock
                payload:
                  target:
                    running: {}
              - action: edit-config
                payload: { get_property: [ turing-machine-update-config-impl, edit-config ] }
                validation:
                  xpath: /_:rpc/_:edit-config/_:config
                  rng: '<grammar xmlns:tm="http://example.net/turing-machine" xmlns="http://relaxng.org/ns/structure/1.0"
                    xmlns:nma="urn:ietf:params:xml:ns:netmod:dsdl-annotations:1" xmlns:nc="urn:ietf:params:xml:ns:netconf:base:1.0"
                    xmlns:en="urn:ietf:params:xml:ns:netconf:notification:1.0" datatypeLibrary="http://www.w3.org/2001/XMLSchema-datatypes"
                    ns="urn:ietf:params:xml:ns:netconf:base:1.0"><define name="__anyxml__"><zeroOrMore><choice><element><anyName/><ref
                    name="__anything__"/></element><text/></choice></zeroOrMore></define><define name="__anything__"><zeroOrMore><choice><attribute><anyName/></attribute><element><anyName/><ref
                    name="__anything__"/></element><text/></choice></zeroOrMore></define><define name="__instance-identifier__"><data
                    type="string"><param name="pattern">(/[a-zA-Z_][a-zA-Z0-9_\-.]*:[a-zA-Z_][a-zA-Z0-9_\-.]*(\[\s*(([a-zA-Z_][a-zA-Z0-9_\-.]*:[a-zA-Z_][a-zA-Z0-9_\-.]*|\.)\s*=\s*("[^"]*"|''[^'']*'')|[0-9]+)\s*\])*)+</param></data></define><define
                    name="message-id-attribute"><attribute name="message-id"><data type="string"><param
                    name="maxLength">4095</param></data></attribute></define><define name="ok-element"><element
                    name="nc:ok"><empty/></element></define><define name="edit-config-parameters"><element
                    name="target"><choice><element name="running"><empty/></element><element name="candidate"><empty/></element></choice></element><optional><element
                    name="default-operation"><choice><value>merge</value><value>replace</value><value>none</value></choice></element></optional><optional><element
                    name="test-option"><choice><value>test-then-set</value><value>set</value><value>test-only</value></choice></element></optional><optional><element
                    name="error-option"><choice><value>stop-on-error</value><value>continue-on-error</value><value>rollback-on-error</value></choice></element></optional></define><define
                    name="eventTime-element"><element name="en:eventTime"><data type="dateTime"/></element></define><start><element
                    name="config"><interleave><grammar ns="http://example.net/turing-machine"><define
                    name="turing-machine__state-index"><data type="unsignedShort"/></define><define
                    name="turing-machine__head-dir"><choice><value>left</value><value>right</value></choice></define><define
                    name="turing-machine__cell-index"><data type="long"/></define><define name="turing-machine__tape-symbol"><data
                    type="string"><param name="minLength">0</param><param name="maxLength">1</param></data></define><define
                    name="turing-machine___tape-cells"><zeroOrMore><element name="cell"><element name="coord"><ref
                    name="turing-machine__cell-index"/></element><optional><element name="symbol"><data
                    type="string"><param name="length">1</param></data></element></optional></element></zeroOrMore></define><start><element
                    name="tm:turing-machine"><interleave><empty/><empty/><optional><empty/></optional><optional><element
                    name="tm:transition-function"><zeroOrMore><element name="tm:delta"><element name="tm:label"><data
                    type="string"/></element><interleave><element name="tm:input"><interleave><element
                    name="tm:state"><ref name="turing-machine__state-index"/></element><element name="tm:symbol"><ref
                    name="turing-machine__tape-symbol"/></element></interleave></element><optional><element
                    name="tm:output"><interleave><optional><element name="tm:state"><ref name="turing-machine__state-index"/></element></optional><optional><element
                    name="tm:symbol"><ref name="turing-machine__tape-symbol"/></element></optional><optional><element
                    name="tm:head-move"><ref name="turing-machine__head-dir"/></element></optional></interleave></element></optional></interleave></element></zeroOrMore></element></optional></interleave></element></start></grammar></interleave></element></start></grammar>'

                  sch: '<sch:schema xmlns:sch="http://purl.oclc.org/dsdl/schematron" queryBinding="exslt"><sch:ns
                    uri="http://exslt.org/dynamic" prefix="dyn"/><sch:ns uri="http://example.net/turing-machine"
                    prefix="tm"/><sch:ns uri="urn:ietf:params:xml:ns:netconf:base:1.0" prefix="nc"/><sch:let
                    name="root" value="/nc:config"/><sch:pattern abstract="true" id="turing-machine___tape-cells"><sch:rule
                    context="$start/$pref:cell"><sch:report test="preceding-sibling::$pref:cell[$pref:coord=current()/$pref:coord]">Duplicate
                    key "coord"</sch:report></sch:rule></sch:pattern><sch:pattern id="turing-machine"><sch:rule
                    context="/nc:config/tm:turing-machine/tm:transition-function/tm:delta"><sch:report
                    test="preceding-sibling::tm:delta[tm:label=current()/tm:label]">Duplicate key "tm:label"</sch:report><sch:report
                    test="preceding-sibling::tm:delta[tm:input/tm:state=current()/tm:input/tm:state
                    and tm:input/tm:symbol=current()/tm:input/tm:symbol]">Violated uniqueness for "tm:input/tm:state
                    tm:input/tm:symbol"</sch:report></sch:rule></sch:pattern><sch:pattern id="idp8148160"
                    is-a="turing-machine___tape-cells"><sch:param name="start" value="/nc:config/tm:turing-machine/tm:tape"/><sch:param
                    name="pref" value="tm"/></sch:pattern></sch:schema>'
              - action: unlock
                payload:
                  target:
                    running: {}

        start:
          inputs:
            calls:
              - action: turing@initialize
                payload: { get_property: [ turing-machine-update-config-impl, turing@initialize ] }

  turing-machine-run-impl:
    type: turing-machine
    properties:
      netconf_auth: { get_property: [ turing-machine-update-config-impl, netconf_auth ] }
    interfaces:
      cloudify.interfaces.lifecycle:
        create:
          inputs:
            calls:
              - action: turing@run
                payload: { get_property: [ turing-machine-run-impl, turing@run ] }
        configure:
          inputs:
            calls:
              - action: get
                # save all results to saved-config
                save_to: new-config
                payload:
                  source:
                    running: {}
                  filter:
                    _@@type: subtree
                    turing@turing-machine:
                      turing@transition-function: {}

    relationships:
      - type: cloudify.relationships.contained_in
        target: turing-machine-update-config-impl

outputs:

  config:
    description: Last config
    value:
      config: { get_attribute: [ turing-machine-update-config-impl, saved-config ] }
      #prefix ns - will be added automaticly
      config_ns: { get_attribute: [ turing-machine-update-config-impl, saved-config_ns ] }
      new-config: { get_attribute: [ turing-machine-run-impl, new-config ] }
      new-config_ns: { get_attribute: [ turing-machine-run-impl, new-config_ns ] }
