tosca_definitions_version: cloudify_dsl_1_2

imports:
  - http://www.getcloudify.org/spec/cloudify/3.3/types.yaml
  - https://raw.githubusercontent.com/cloudify-cosmo/cloudify-netconf-plugin/master/plugin.yaml

inputs:

  netconf_ip:
    type: string
    description: >
       netconf server ip
    default: 127.0.0.1

  netconf_user:
    type: string
    description: >
       netconf server user
    default: netconf
  netconf_password:
    type: string
    description: >
       netconf server user password
    default: netconf

node_types:

  turing-machine:
    derived_from: cloudify.netconf.nodes.xml_rpc
    properties:
      schema:
        default:
          turing-machine:
            description: "State data and configuration of a Turing Machine."
            keyword: container
            children:
              state:
                keyword: leaf
                type: state-index
                config: false
                mandatory: true
                description: "Current state of the control unit. The initial state is 0."
              head-position:
                keyword: leaf
                type: cell-index
                config: false
                mandatory: true
                description: "Position of tape read/write head."
              tape:
                keyword: container
                config: false
                description: "The contents of the tape."
                children:
                  cell:
                    keyword: list
                    key: coord
                    description: "List of non-blank cells."
                    children:
                      coord:
                        type: cell-index
                        keyword: leaf
                        description: "Coordinate (index) of the tape cell."
                      symbol:
                        keyword: leaf
                        type: tape-symbol
                        description: "Symbol appearing in the tape cell."
              transition-function:
                description: "The Turing Machine is configured by specifying the transition function."
                keyword: container
                children:
                  delta:
                    keyword: list
                    key: label
                    description: The list of transition rules.
                    children:
                        label:
                          keyword: leaf
                          type: string
                          description: "An arbitrary label of the transition rule."
                        input:
                          keyword: container
                          description: "Input parameters (arguments) of the transition rule."
                          children:
                            state:
                              type: state-index
                              keyword: leaf
                              description: "Current state of the control unit."
                            symbol:
                              type: tape-symbol
                              keyword: leaf
                              description: "Symbol read from the tape cell."
                        output:
                          keyword: container
                          description: "Output values of the transition rule."
                          children:
                            state:
                              type: state-index
                              keyword: leaf
                              description: "New state of the control unit. If this leaf is not present, the state doesn't change."
                            symbol:
                              type: tape-symbol
                              keyword: leaf
                              description: "Symbol to be written to the tape cell. If this leaf is not present, the symbol doesn't change."
                            head-move:
                              type: head-dir
                              keyword: leaf
                              description: "Move the head one cell to the left or right"
          initialize:
            keyword: rpc
            description: "Initialize the Turing Machine"
            input:
              tape-content:
                keyword: leaf
                type: string
                default: ""
                description: "The string with which the tape shall be initialized."
          run:
            keyword: rpc
            description: "Start the Turing Machine operation."
          halted:
            keyword: notification
            children:
              state:
                keyword: leaf
                type: state-index
                mandatory: true
                description: "The state of the control unit in which the machine has halted."
      metadata:
        default:
          xmlns:
            _: urn:ietf:params:xml:ns:netconf:base:1.0
            turing: http://example.net/turing-machine
            t2: http://example.net/turing-machine/tape-2
          capabilities:
            - http://example.net/turing-machine?module=turing-machine&revision=2013-12-27
          relax_ng: 'content of xml'
          scematron: 'content of xml'
          yang_files:
            - filename.yang
          features:
            - features list

  turing-machine-update-config:
    derived_from: turing-machine
    properties:
      netconf_auth:
        default: {}
      edit-config:
        default: {}
      turing@initialize:
        default: {}
      get-config:
        default:
          source:
            running: {}

  turing-machine-run:
    derived_from: turing-machine
    properties:
      netconf_auth:
        default: {}
      turing@run:
        default: {}

# -------------------------------------------------------

node_templates:


  turing-machine-update-config-impl:
    type: turing-machine-update-config
    properties:
      netconf_auth:
        user:  { get_input: netconf_user }
        password: { get_input: netconf_user }
        ip:  { get_input: netconf_ip }
      turing@initialize:
        turing@tape-content: 101010101
      edit-config:
        error-option: rollback-on-error
        target:
          running: {}
        config:
          turing@turing-machine:
            turing@transition-function:
              turing@delta:
                - turing@label: 1
                  turing@input:
                    turing@symbol: 0
                    turing@state: 0
                  turing@output:
                    turing@symbol: {}
                    turing@state: 1
                    turing@head-move: right
                - turing@label: 2
                  turing@input:
                    turing@symbol: 0
                    turing@state: 1
                  turing@output:
                    turing@symbol: 0
                    turing@state: 1
                    turing@head-move: right

    interfaces:
      cloudify.interfaces.lifecycle:
        create:
          inputs:
            action: get-config
            payload: { get_property: [ turing-machine-update-config-impl, get-config ] }
            # save all results to saved-config
            save_to: saved-config
        configure:
          inputs:
            action: edit-config
            payload: { get_property: [ turing-machine-update-config-impl, edit-config ] }
        start:
          inputs:
            action: turing@initialize
            payload: { get_property: [ turing-machine-update-config-impl, turing@initialize ] }

  turing-machine-run-impl:
    type: turing-machine-run
    properties:
      netconf_auth: { get_property: [ turing-machine-update-config-impl, netconf_auth ] }
    interfaces:
      cloudify.interfaces.lifecycle:
        create:
          inputs:
            action: turing@run
            payload: { get_property: [ turing-machine-run-impl, turing@run ] }
        configure:
          inputs:
            action: get
            # save all results to saved-config
            save_to: new-config
            payload:
              source:
                running: {}
              filter:
                _@@type: subtree
                turing@turing-machine:
                  turing@transition-function: {}

    relationships:
      - type: cloudify.relationships.contained_in
        target: turing-machine-update-config-impl

outputs:

  endpoint:
    description: Last config
    value:
      config: { get_attribute: [ turing-machine-update-config-impl, saved-config ] }
      #prefix ns - will be added automaticly
      config_ns: { get_attribute: [ turing-machine-update-config-impl, saved-config_ns ] }
      new-config: { get_attribute: [ turing-machine-run-impl, new-config ] }
      new-config_ns: { get_attribute: [ turing-machine-run-impl, new-config_ns ] }
